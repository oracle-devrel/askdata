
DROP TABLE TRUST_LIBRARY;

DROP TABLE MODEL_USAGE;

DROP TABLE APP_USERS;

DROP TABLE EXECUTION_LOG;

DROP TABLE TRAININGDATA_HISTORY;

DROP TABLE FINETUNE_WORKFLOW;

DROP TABLE FINETUNE_EVALUATION;

DROP TABLE FINETUNE_CONFIG;

-- DONT DROP THE SCHEMA_VERSION TABLE
CREATE TABLE schema_version (
    version_number VARCHAR(50) NOT NULL,
    description TEXT,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_by VARCHAR(100),
    script_name VARCHAR(255)
);

-- oracle sql syntax
CREATE TABLE schema_version (
    version_number VARCHAR2(50) NOT NULL,
    description CLOB,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_by VARCHAR2(100),
    script_name VARCHAR2(255)
);

INSERT INTO schema_version(version_number, description, applied_by, script_name) 
    VALUES ('2025W21', 'All recent modifications', 'Demo user', 'nl2sql_datamodel_schema.sql');

CREATE TABLE TRUST_LIBRARY (
    ID              NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    CERTIFIED_DATE  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    PROMPT_TXT      VARCHAR2(4000 BYTE) NOT NULL,
    PROMPT_VECT     VECTOR NOT NULL,  -- VECTOR DATA TYPE FOR EMBEDDING STORAGE
    SQL_TXT         VARCHAR2(4000 BYTE) NOT NULL,
    certify_state_id NUMBER
);

-- Code expects at least one entry in Trust library

INSERT INTO TRUST_LIBRARY (
    CERTIFIED_DATE,
    PROMPT_TXT,
    PROMPT_VECT,
    SQL_TXT,
    certify_state_id
)
VALUES (
    SYSTIMESTAMP,
    'show all vendors',
    '[3.26843262E-002,7.88116455E-003,-2.45666504E-002,-9.19799805E-002,-2.61077881E-002,-1.55563354E-002,-1.00524902E-001,-1.52111053E-003,9.07897949E-003,4.93164062E-002,2.22320557E-002,-1.96075439E-002,-2.09655762E-002,-2.08587646E-002,-1.84020996E-002,-4.17709351E-003,5.2947998E-002,-5.31005859E-003,3.57666016E-002,1.49765015E-002,-1.30996704E-002,6.18591309E-002,-3.36914062E-002,-4.79888916E-003,2.97851562E-002,-2.76641846E-002,-1.48773193E-002,-1.51977539E-002,2.99530029E-002,-4.4708252E-003,3.67546082E-003,1.02996826E-002,1.82647705E-002,-3.25927734E-002,3.84216309E-002,1.09863281E-002,-7.15255737E-003,-1.87225342E-002,1.35116577E-002,-7.49206543E-003,-8.38756561E-004,-1.20010376E-002,-7.96508789E-003,-3.24707031E-002,-5.78918457E-002,-3.25965881E-003,1.4251709E-002,1.9821167E-002,1.96075439E-002,-2.21557617E-002,-5.27572632E-003,-1.5296936E-002,1.95617676E-002,4.89501953E-002,-4.42504883E-002,1.17206573E-003,-1.42211914E-002,3.46565247E-003,1.71756744E-003,-3.60717773E-002,-2.69775391E-002,3.74450684E-002,1.48849487E-002,1.70898438E-002,-1.71051025E-002,-1.18942261E-002,6.48498535E-003,-5.52654266E-004,1.82037354E-002,-3.41796875E-002,-1.84173584E-002,-1.57928467E-002,3.05366516E-003,-1.82800293E-002,5.33752441E-002,-2.78625488E-002,-2.10113525E-002,3.73125076E-004,-1.18103027E-002,2.7633667E-002,-1.39007568E-002,2.64587402E-002,-2.57873535E-002,-2.7053833E-002,1.14059448E-002,-7.77435303E-003,8.17871094E-003,-1.94702148E-002,2.86102295E-002,-6.5246582E-002,-1.33056641E-002,4.40368652E-002,-1.61132812E-002,4.36706543E-002,-1.39465332E-002,-4.47998047E-002,2.74047852E-002,5.58166504E-002,-5.75866699E-002,-4.49523926E-002,-4.98352051E-002,-1.07879639E-002,-5.25817871E-002,-2.51617432E-002,-4.06799316E-002,-1.44958496E-002,4.0222168E-002,9.33227539E-002,5.2154541E-002,5.83496094E-002,-4.30679321E-003,5.92651367E-002,2.83660889E-002,4.33349609E-002,-3.125E-002,-4.9621582E-002,-4.58984375E-002,2.35595703E-002,-3.12347412E-002,-5.89752197E-003,-9.49382782E-004,2.69165039E-002,4.63247299E-004,-4.7492981E-003,-1.7364502E-002,2.85339355E-003,5.7144165E-003,-3.17687988E-002,-1.85089111E-002,-2.0690918E-002,-2.23388672E-002,1.23138428E-002,-5.85632324E-002,1.6494751E-002,1.67369843E-003,-1.99890137E-002,-4.68444824E-002,-3.4576416E-002,-1.6494751E-002,3.32450867E-003,2.97393799E-002,-2.44750977E-002,4.17175293E-002,1.95465088E-002,-7.28988647E-003,1.01928711E-002,2.26593018E-002,1.17416382E-002,-1.13449097E-002,5.24139404E-003,-2.44903564E-002,3.36914062E-002,-2.94342041E-002,8.04443359E-002,4.9407959E-002,8.11767578E-002,4.28466797E-002,4.51803207E-004,-1.77764893E-002,3.69262695E-002,-6.50787354E-003,1.43051147E-003,4.94689941E-002,-2.28271484E-002,-2.51617432E-002,-2.37579346E-002,-3.30352783E-003,6.76345825E-003,3.07922363E-002,2.0111084E-002,-5.54199219E-002,-2.02636719E-002,5.73120117E-002,3.3416748E-002,-1.0635376E-002,5.93261719E-002,-4.75692749E-003,-2.83241272E-004,4.57458496E-002,-6.69555664E-002,-1.69219971E-002,-2.63214111E-002,3.09753418E-002,1.83105469E-002,-8.73413086E-002,-5.9928894E-003,1.24130249E-002,4.8034668E-002,3.56140137E-002,3.17955017E-003,7.40966797E-002,-1.89208984E-002,-1.30386353E-002,7.21359253E-003,3.37600708E-003,3.56750488E-002,-6.33544922E-002,2.4810791E-002,-2.88391113E-002,-2.08740234E-002,-4.65393066E-002,-1.90448761E-003,7.19070435E-003,1.71661377E-002,7.86743164E-002,-2.30407715E-002,3.99169922E-002,-2.21405029E-002,1.95770264E-002,2.4887085E-002,-9.29355621E-004,1.79100037E-003,-1.98364258E-002,-3.86962891E-002,-4.1595459E-002,1.11160278E-002,-5.13000488E-002,-7.61795044E-003,4.81796265E-003,4.59594727E-002,5.43518066E-002,-3.26538086E-002,2.07977295E-002,2.35137939E-002,1.43661499E-002,1.66931152E-002,-2.23236084E-002,7.71999359E-004,2.28424072E-002,9.97161865E-003,2.57873535E-002,6.26373291E-003,-2.67944336E-002,1.96228027E-002,-4.52270508E-002,-2.50396729E-002,-2.65350342E-002,3.15856934E-002,2.63824463E-002,1.60064697E-002,-1.1505127E-002,1.9744873E-002,-4.7454834E-002,-1.14154816E-003,1.6204834E-002,2.08282471E-002,2.06756592E-002,2.32086182E-002,-4.69207764E-003,4.28466797E-002,-1.54418945E-002,6.34765625E-003,1.00784302E-002,4.19311523E-002,-1.0055542E-002,4.16259766E-002,3.41491699E-002,7.91931152E-003,-2.23083496E-002,4.51965332E-002,-3.19824219E-002,-4.81033325E-003,-1.55792236E-002,-2.91290283E-002,-5.34362793E-002,8.28552246E-003,-2.03399658E-002,-9.55963135E-003,-2.79998779E-002,3.47709656E-003,3.22875977E-002,-3.31306458E-003,-1.76086426E-002,1.32217407E-002,5.24520874E-003,1.90887451E-002,-2.05993652E-002,3.08990479E-003,-4.17785645E-002,1.7791748E-002,1.20391846E-002,-6.54697418E-004,2.67028809E-002,1.93023682E-002,1.10702515E-002,-1.23672485E-002,2.47955322E-002,2.27661133E-002,-2.24609375E-002,-2.87628174E-002,1.3710022E-002,3.64685059E-002,-1.28707886E-002,2.47497559E-002,2.44903564E-002,-3.23295593E-003,-4.00390625E-002,2.79541016E-002,-3.58009338E-003,-4.77905273E-002,-3.9276123E-002,1.79901123E-002,-4.92553711E-002,2.81982422E-002,9.53674316E-003,2.19116211E-002,6.33621216E-003,-2.44379044E-004,3.7021637E-003,-4.00161743E-003,-1.62029266E-003,2.15759277E-002,4.84085083E-003,1.54266357E-002,-4.03442383E-002,-4.98046875E-002,-2.44293213E-002,-4.49523926E-002,-8.23974609E-002,-4.39453125E-002,-3.86352539E-002,4.11987305E-002,-3.63464355E-002,-3.50952148E-002,3.11584473E-002,9.79614258E-003,-8.09936523E-002,-7.91072845E-004,-3.36914062E-002,-3.99780273E-003,9.88769531E-003,-2.71453857E-002,2.15606689E-002,-9.42230225E-003,-1.08528137E-003,-3.77197266E-002,1.38549805E-002,6.87255859E-002,3.55224609E-002,5.39302826E-004,4.15649414E-002,4.22058105E-002,-1.64642334E-002,-5.00488281E-003,-1.09786987E-002,-1.09939575E-002,1.19476318E-002,-1.10549927E-002,-2.90527344E-002,3.2043457E-002,2.01721191E-002,-1.46484375E-002,8.24737549E-003,-2.83355713E-002,3.17687988E-002,-3.74450684E-002,-3.67431641E-002,-1.49154663E-002,-5.54275513E-003,-7.92236328E-002,2.60467529E-002,-3.71551514E-003,-2.96325684E-002,-3.75976562E-002,6.11877441E-003,-5.82885742E-002,5.3024292E-003,-3.59802246E-002,-1.32598877E-002,-1.02310181E-002,-1.19857788E-002,-3.18336487E-003,-1.03302002E-002,2.61230469E-002,-1.79595947E-002,2.15759277E-002,1.10092163E-002,-4.17175293E-002,-4.44793701E-003,-1.29470825E-002,3.39355469E-002,4.89807129E-002,3.05328369E-002,3.97644043E-002,-2.69699097E-003,2.15411186E-004,-1.87988281E-002,2.59399414E-002,-2.89535522E-003,3.02124023E-002,-2.21405029E-002,-5.56564331E-003,4.11376953E-002,-1.5045166E-002,-2.92396545E-003,-2.03094482E-002,1.78527832E-002,1.6784668E-002,-2.57568359E-002,-2.45475769E-003,-3.42712402E-002,-7.45773315E-003,-4.13818359E-002,-3.41796875E-002,-2.14767456E-003,-1.21582031E-001,3.72695923E-003,-4.86755371E-002,8.47625732E-003,3.06243896E-002,-2.16674805E-002,2.72369385E-002,-1.78070068E-002,-2.87294388E-004,-2.0980835E-002,4.37545776E-003,-3.15246582E-002,1.17588043E-003,1.42593384E-002,4.78820801E-002,9.80377197E-003,-3.20739746E-002,-2.33001709E-002,2.73742676E-002,-1.36566162E-002,2.18811035E-002,6.22177124E-003,1.59912109E-002,-4.799366E-004,-2.98500061E-003,-4.48226929E-003,-1.81274414E-002,-5.40924072E-003,-1.50527954E-002,-5.23376465E-002,-5.65185547E-002,-3.56445312E-002,-9.42993164E-003,3.2409668E-002,-6.16760254E-002,-8.2321167E-003,-8.80718231E-004,2.92816162E-002,-2.33154297E-002,-9.01222229E-004,-2.25067139E-002,5.55114746E-002,-1.66015625E-002,-5.76171875E-002,-2.57568359E-002,-6.20727539E-002,3.28369141E-002,-6.76345825E-003,2.28271484E-002,2.25524902E-002,-5.22155762E-002,1.6204834E-002,7.1144104E-003,2.0401001E-002,5.94787598E-002,4.99267578E-002,9.64355469E-003,-3.95507812E-002,1.24816895E-002,-3.14025879E-002,1.45645142E-002,-1.80053711E-002,2.11000443E-004,-2.27508545E-002,-4.51278687E-003,-7.3890686E-003,4.71801758E-002,-3.70788574E-002,-2.29034424E-002,2.50854492E-002,2.83432007E-003,8.11767578E-003,-1.45111084E-002,9.86480713E-003,-9.04083252E-003,2.38952637E-002,-1.52359009E-002,5.56335449E-002,-1.85546875E-002,5.02319336E-002,-7.75146484E-003,-2.30407715E-002,2.15606689E-002,1.61590576E-002,7.10449219E-002,1.13143921E-002,1.40151978E-002,4.08935547E-003,2.14996338E-002,-3.68041992E-002,1.22070312E-002,-1.12838745E-002,-3.03344727E-002,1.58996582E-002,-5.37414551E-002,-2.18963623E-002,5.71060181E-003,-1.49383545E-002,6.90460205E-003,1.50375366E-002,-5.18798828E-003,4.11376953E-002,9.13238525E-003,1.21459961E-002,-4.99343872E-003,4.65698242E-002,-2.53601074E-002,1.7578125E-002,-1.23500824E-003,-3.57971191E-002,4.02832031E-002,-3.75976562E-002,-6.19506836E-002,-3.08418274E-003,2.5177002E-002,6.26831055E-002,4.18701172E-002,4.65087891E-002,1.54800415E-002,1.46102905E-002,2.33840942E-003,8.75091553E-003,-2.38494873E-002,-3.84216309E-002,-3.72009277E-002,8.20159912E-003,1.58233643E-002,4.11376953E-002,1.77154541E-002,2.05078125E-002,3.09143066E-002,-4.50515747E-003,2.22930908E-002,9.63687897E-004,-4.54101562E-002,-3.36074829E-003,5.7144165E-003,-4.13818359E-002,-2.27508545E-002,2.70080566E-003,-4.30603027E-002,-1.18103027E-002,2.28881836E-002,-8.95690918E-003,-2.0904541E-002,5.49621582E-002,3.73840332E-002,-3.94287109E-002,1.80969238E-002,2.96592712E-003,-8.09326172E-002,-6.82983398E-002,1.85546875E-002,-6.71386719E-002,2.23846436E-002,-5.26428223E-003,3.42712402E-002,-4.09851074E-002,1.97601318E-002,-3.08837891E-002,-9.73510742E-003,4.31518555E-002,3.23181152E-002,2.30407715E-002,-1.71813965E-002,-2.3651123E-003,-1.25656128E-002,3.95202637E-002,-1.71356201E-002,-2.51464844E-002,-2.2644043E-002,-3.00216675E-003,-1.52587891E-003,5.61141968E-003,-1.90429688E-002,4.89807129E-002,1.12686157E-002,-1.54571533E-002,-2.18048096E-002,4.51660156E-002,5.83190918E-002,-4.73937988E-002,1.96075439E-002,-8.27026367E-003,1.3092041E-002,-5.95703125E-002,9.60540771E-003,-2.12554932E-002,-8.41064453E-002,7.1105957E-003,8.3770752E-003,-2.80914307E-002,2.31933594E-002,1.01947784E-003,7.46154785E-003,1.62506104E-002,-3.75671387E-002,2.12554932E-002,-7.06481934E-003,5.76477051E-002,-4.09240723E-002,7.1105957E-003,2.39105225E-002,3.41796875E-003,3.43704224E-003,8.43811035E-003,-2.54821777E-002,-9.88006592E-003,1.9821167E-002,-7.24411011E-003,-6.71386719E-003,2.63214111E-002,3.56140137E-002,-1.46102905E-002,-7.01293945E-002,1.48010254E-002,8.53538513E-004,8.38470459E-003,3.73535156E-002,-3.92456055E-002,-1.38244629E-002,-1.04370117E-002,6.11305237E-004,1.72729492E-002,1.49765015E-002,9.68170166E-003,-9.50622559E-003,-3.31115723E-002,-4.5715332E-002,1.56402588E-002,2.92205811E-002,1.07040405E-002,-1.15280151E-002,1.612854E-002,2.88543701E-002,-9.65118408E-003,3.40881348E-002,5.52368164E-002,-3.38134766E-002,3.06854248E-002,-5.57250977E-002,5.35964966E-003,1.98059082E-002,-1.46255493E-002,-1.97906494E-002,7.32803345E-003,-3.88860703E-004,2.22473145E-002,-6.63757324E-003,4.42504883E-002,-1.17416382E-002,-3.23486328E-002,-1.40991211E-002,-1.5411377E-002,-4.44335938E-002,-7.56263733E-004,2.64129639E-002,-5.76171875E-002,5.9387207E-002,2.3223877E-002,-9.44519043E-003,2.96325684E-002,5.18798828E-002,-2.77709961E-002,-3.15093994E-003,4.00161743E-003,3.41033936E-003,-1.13983154E-002,-2.94952393E-002,-6.10961914E-002,2.74963379E-002,2.39562988E-003,1.55639648E-002,9.41467285E-003,5.33447266E-002,-1.3130188E-002,3.99475098E-002,6.16760254E-002,-2.4597168E-002,-3.22570801E-002,3.85131836E-002,-7.09915161E-003,-2.8793335E-002,4.40216064E-003,-2.47039795E-002,-3.51257324E-002,2.70080566E-002,-4.72640991E-003,1.71813965E-002,2.83002853E-004,5.39245605E-002,-4.52880859E-002,9.65118408E-003,3.17382812E-002,2.60925293E-002,4.07714844E-002,-1.71508789E-002,-1.06964111E-002,-4.21447754E-002,1.84936523E-002,4.84619141E-002,-2.00653076E-002,1.53503418E-002,-2.36053467E-002,1.60675049E-002,1.12991333E-002,-8.07189941E-003,-7.17544556E-003,-3.95584106E-003,9.29260254E-003,1.39846802E-002,4.01916504E-002,3.49121094E-002,7.6789856E-003,-9.31549072E-003,-1.37710571E-002,-2.24151611E-002,-1.06201172E-002,-8.68225098E-003,2.97088623E-002,4.12750244E-003,-4.45251465E-002,2.14080811E-002,3.08532715E-002,2.75421143E-002,-7.38620758E-004,-5.98144531E-002,1.1756897E-002,-1.60522461E-002,1.20544434E-002,-3.40576172E-002,2.0980835E-002,2.69927979E-002,-1.5296936E-002,-2.60772705E-002,-3.41491699E-002,5.84411621E-003,2.01568604E-002,2.96211243E-003,2.78320312E-002,4.03137207E-002,7.12203979E-003,6.60400391E-002,1.41448975E-002,1.08413696E-002,2.32543945E-002,4.29992676E-002,-2.78015137E-002,-1.07116699E-002,-7.40432739E-003,-1.74865723E-002,-7.75756836E-002,-1.85699463E-002,-1.20773315E-002,2.49481201E-002,-8.80737305E-002,1.12609863E-002,-2.35900879E-002,1.23748779E-002,2.46429443E-002,-2.2644043E-002,-6.59790039E-002,2.27966309E-002,5.03540039E-002,-4.59671021E-003,-1.16577148E-002,7.01293945E-002,2.32505798E-003,-3.65600586E-002,-5.29174805E-002,-3.38172913E-003,-2.27661133E-002,2.25372314E-002,-7.58361816E-003,4.17480469E-002,7.16781616E-003,7.41577148E-002,1.0383606E-002,-2.67486572E-002,-2.44903564E-002,1.0559082E-002,4.13513184E-002,4.89807129E-002,-1.50222778E-002,4.57763672E-002,9.46807861E-003,4.73327637E-002,2.14538574E-002,6.89697266E-003,2.45094299E-003,2.35557556E-003,4.40063477E-002,1.42211914E-002,7.36694336E-002,1.62963867E-002,3.29399109E-003,-6.10351562E-002,-3.08990479E-002,-3.42102051E-002,-1.70593262E-002,-3.81774902E-002,-3.89404297E-002,3.0380249E-002,2.5100708E-003,-1.20925903E-002,1.68914795E-002,-9.16290283E-003,1.48925781E-002,4.33654785E-002,4.58908081E-003,3.9276123E-002,-3.07312012E-002,-1.22146606E-002,-3.74755859E-002,2.3147583E-002,2.55584717E-003,1.17263794E-002,3.79333496E-002,2.14691162E-002,-3.70788574E-003,-2.24761963E-002,1.18179321E-002,1.9569397E-003,6.09970093E-003,3.74755859E-002,2.31933594E-002,-2.34222412E-002,2.91900635E-002,6.72607422E-002,6.99462891E-002,-4.2175293E-002,-7.3059082E-002,5.67016602E-002,2.0324707E-002,-5.43212891E-002,4.07104492E-002,-2.45056152E-002,4.58374023E-002,-1.14135742E-002,5.05065918E-003,2.08740234E-002,3.24707031E-002,-1.29699707E-002,2.94342041E-002,2.42042542E-003,5.42297363E-002,-1.75018311E-002,-1.49307251E-002,7.8125E-003,2.49633789E-002,1.46150589E-004,4.62341309E-002,-2.74047852E-002,-4.76074219E-003,3.81469727E-002,1.81388855E-003,7.58361816E-003,-1.75170898E-002,5.03158569E-003,6.61468506E-003,4.22973633E-002,-2.44140625E-002,-6.43920898E-003,1.25198364E-002,-1.26113892E-002,1.56555176E-002,3.10668945E-002,4.80651855E-002,-3.07922363E-002,-2.35595703E-002,5.45654297E-002,-1.89495087E-003,-5.10253906E-002,6.34002686E-003,5.89599609E-002,-2.2567749E-002,-5.86032867E-004,-1.89208984E-002,6.72912598E-003,-3.80554199E-002,-9.81140137E-003,-1.26571655E-002,8.74328613E-003,-5.95474243E-003,-2.16827393E-002,5.13839722E-003,-1.78527832E-002,3.47900391E-002,-1.19857788E-002,-2.50091553E-002,-5.17272949E-002,1.72576904E-002,9.88006592E-003,-3.29589844E-002,-1.76696777E-002,-1.04751587E-002,-4.19921875E-002,2.73590088E-002,-4.22058105E-002,2.65808105E-002,-1.07192993E-002,-1.54571533E-002,1.10626221E-002,1.45721436E-002,-3.54919434E-002,4.53796387E-002,7.29370117E-002,-3.47290039E-002,-3.36608887E-002,1.06277466E-002,1.41448975E-002,-4.24499512E-002,6.48117065E-003,-9.0713501E-003,4.12902832E-002,-2.60162354E-002,-3.87954712E-003,1.97601318E-002,-2.34985352E-002,-7.47070312E-002,2.02789307E-002,-6.60400391E-002,1.01547241E-002,-2.40631104E-002,1.63269043E-003,1.37557983E-002,7.17926025E-003,-2.21252441E-003,8.60595703E-002,8.12530518E-003,2.37464905E-003,-5.02624512E-002,2.97546387E-002,-5.39779663E-003,2.85644531E-002,-2.26135254E-002,2.73704529E-003,5.61904907E-003,3.8482666E-002,-2.38647461E-002,8.44573975E-003,4.20837402E-002,-1.73034668E-002,1.07345581E-002,-1.46789551E-002,2.81524658E-002,-1.92718506E-002,3.32832336E-004,-2.31933594E-002,1.9821167E-002,2.15606689E-002,-5.08422852E-002,-3.90625E-002,8.90731812E-004,3.96118164E-002,-7.43865967E-003,7.76977539E-002,3.34472656E-002,1.83563232E-002,-7.06176758E-002,-4.65011597E-003,-3.3203125E-002,2.7053833E-002,5.24902344E-002,4.36401367E-002,-6.690979E-003,3.17382812E-002,-3.18603516E-002,6.02111816E-002,3.18908691E-002,-2.3223877E-002,-3.2043457E-002,2.06756592E-003,-2.23693848E-002,-3.86962891E-002,2.40478516E-002,7.77053833E-003,9.05609131E-003,-3.515625E-002,4.48608398E-002,1.3420105E-002,-4.00695801E-002,-4.48303223E-002,-3.50646973E-002,-1.21231079E-002,-4.99267578E-002,-1.12792969E-001,-9.2590332E-002,-5.6427002E-002,3.64685059E-002,3.34777832E-002,-4.16259766E-002,-1.04675293E-002,1.80244446E-003,1.55715942E-002,-5.31616211E-002,4.44641113E-002,4.34875488E-002,2.86712646E-002,-4.63867188E-003,4.46777344E-002,5.82885742E-002,2.82440186E-002,-6.40869141E-002,-1.93481445E-002,-1.18026733E-002,2.37426758E-002,-1.31454468E-002,2.65960693E-002,6.40258789E-002,-5.48400879E-002,-2.61993408E-002,-5.02929688E-002,-2.13775635E-002,-5.21240234E-002,-2.27661133E-002,4.76455688E-003,-7.19070435E-003,2.21557617E-002]', 
    'select v.vendor_name, v.vendor_site_details from vendors v',
    1
);

-- Add description for the columns
-- This is a manual entry table. This insert needs to be done from a sql ide.
-- examples below.
CREATE TABLE MODEL_USAGE (
    ID                 NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    MODEL_PURPOSE      VARCHAR2(4000 BYTE) NOT NULL,
    MODEL_SRC          VARCHAR2(100),
    MODEL_NAME         VARCHAR2(200 BYTE)  NOT NULL,
    USAGE_START        TIMESTAMP DEFAULT SYSTIMESTAMP,
    USAGE_STOP         TIMESTAMP, -- null means active
    WORKFLOW_ID        NUMBER,         
    ENDPOINT_OCID      VARCHAR2(1000),
    DAC_CLUSTER_OCID   VARCHAR2(1000), 
    VERSION            VARCHAR2(128)
);

-- version needs to be updated. Needs to include the first 4 columns (except usage stop)
-- TODO: set the start_time to the upload of this schema.
INSERT INTO MODEL_USAGE(MODEL_PURPOSE,MODEL_NAME,MODEL_SRC,USAGE_START) VALUES ('GEN-PURPOSE-LLM','meta-llama-3.3-70b','DAC', SYSTIMESTAMP););
INSERT INTO MODEL_USAGE(MODEL_PURPOSE,MODEL_NAME,MODEL_SRC,USAGE_START) VALUES ('EMBEDDINGS-MODEL','cohere.embed-english-v3.0','OCI-PUBLIC', SYSTIMESTAMP););
COMMIT;

-- Need description and usage information.
CREATE TABLE APP_USERS (
    ID            NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    EMAIL_ADDRESS VARCHAR2(200 BYTE) NOT NULL
);

CREATE UNIQUE INDEX UNQ_APP_USERS_EMAIL
ON APP_USERS (LOWER(EMAIL_ADDRESS));

INSERT INTO APP_USERS (EMAIL_ADDRESS) values ('anonymous@gmail.com');
COMMIT;

CREATE TABLE EXECUTION_LOG(
    ID                      NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    LLM_ID                  NUMBER,
    EXECUTION_DATE          TIMESTAMP DEFAULT SYSTIMESTAMP,
    USER_ID                 NUMBER NOT NULL,
    TRUST_ID                NUMBER,
    TRUST_SCORE             NUMBER,
    USER_PROMPT             VARCHAR2(4000 BYTE),
    CONVO_PROMPT            VARCHAR2(4000 BYTE),
    CONVO_ID                VARCHAR2(255 BYTE),
    CONVO_SEQ_NUM           NUMBER,
    GENERATED_SQL           VARCHAR2(4000 BYTE),  -- GEN BY LLM
    IS_TRUSTED              NUMBER DEFAULT 0 NOT NULL,
    IS_PROMPT_EQUIV         NUMBER DEFAULT 0 NOT NULL,
    IS_TEMPLATE_EQUIV       NUMBER DEFAULT 0 NOT NULL,
    EXECUTED_SQL            VARCHAR2(4000 BYTE),  -- SENT TO SOURCE DB
    DB_ERROR_CODE           VARCHAR2(255 BYTE),
    DB_ERROR_TXT            VARCHAR2(2000 BYTE),
    IS_AUTHORIZED           NUMBER DEFAULT 0 NOT NULL,
    IS_CLARIFY              NUMBER DEFAULT 0 NOT NULL,
    IS_ACTION               NUMBER DEFAULT 0 NOT NULL,
    ACTION_TYPE             VARCHAR2(255 BYTE),
    USER_FEEDBACK_CODE      NUMBER DEFAULT 0 NOT NULL,
    USER_FEEDBACK_TXT       VARCHAR2(4000 BYTE) DEFAULT 0 NOT NULL,
    IS_CERT_PROCESSED       NUMBER DEFAULT 0 NOT NULL
);

ALTER TABLE EXECUTION_LOG ADD CONSTRAINT FK_EXECUTION_LOG_TRUST_LIBRARY FOREIGN KEY(TRUST_ID) REFERENCES TRUST_LIBRARY(ID);
ALTER TABLE EXECUTION_LOG ADD CONSTRAINT FK_EXECUTION_LOG_USER FOREIGN KEY(USER_ID)  REFERENCES APP_USERS(ID);
ALTER TABLE EXECUTION_LOG ADD CONSTRAINT FK_EXECUTION_LOG_MODEL_USAGE FOREIGN KEY(LLM_ID)  REFERENCES MODEL_USAGE(ID);

CREATE TABLE APP_DEBUG_DATA (
  PARENT_ID  NUMBER,
  DEBUG_DATA VARCHAR2(32000),
  TSTMP TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE CERTIFY_STATE (
    ID NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    PROMPT_PROC_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    PROMPT_TXT VARCHAR2(4000 BYTE),
    IS_SQL_PROC NUMBER DEFAULT 0 NOT NULL,
    SQL_PROC_DATE TIMESTAMP,
    SQL_TXT VARCHAR2(4000 BYTE),
    PARSE_ERROR_CODE VARCHAR2(4000 BYTE),
    IS_STAGED_PROC NUMBER DEFAULT 0 NOT NULL,
    STAGED_PROC_DATE TIMESTAMP,
    PASS_FAIL VARCHAR2(255),
    CORRECTED_SQL_TXT VARCHAR2(4000 BYTE),
    IS_CERT_PROC NUMBER DEFAULT 0 NOT NULL,
    CERT_PROC_DATE TIMESTAMP,                                        
    -- metadata around the prompt source
    PROMPT_SOURCE VARCHAR(255 BYTE),                                 -- auto, upload, user
    UPLOAD_FILENAME VARCHAR2(4000 BYTE),
    USER_EXECUTION_ID NUMBER,                                        -- FK to execution_log
    METADATA_1 VARCHAR2(4000 BYTE),
    METADATA_2 VARCHAR2(4000 BYTE)
);

--The referencial integrity is enforced at the application level.
--When a mistake entry in the trust library needs to be removed (occurs when experts certifies incorrectly) 
--then, the entry will be deleted from the trust library and two fields(is_cert_proc=0, cert_proc_date=null) will be updated in certify state
--it will thereby revert to its pre-certification state.
--sblais and gkeys - 14 april 2025
--alter table trust_library add constraint FK_TRUST_LIBRARY_CERTIFY_STATE FOREIGN KEY (certify_state_id) REFERENCES CERTIFY_STATE(ID);

CREATE TABLE FINETUNE_WORKFLOW (
    ID	NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
		
		-- step 1: configure
    WORKFLOW_KEY  VARCHAR(255 BYTE),						-- key for each workflow (completed or aborted), modelname from UI + tstamp appended at submit
    MODEL_USAGE_ID NUMBER,
    TRAINING_DATA_ID  NUMBER,			                    -- FK to training data history
    MODEL_DESCR     VARCHAR2(4000 BYTE),					-- from UI
    UNIT_COUNT     NUMBER,									-- from config
    UNIT_SHAPE     VARCHAR(255 BYTE),						-- from config
    CONFIG_STATE     VARCHAR(255 BYTE),						-- values: 'empty' (default), 'cleared', 'set' based on button clicked ('cleared' starts new workflow_id)
    DEPLOY_STATE     VARCHAR(255 BYTE),
    CONFIG_SUBMIT_TIME	TIMESTAMP DEFAULT SYSTIMESTAMP,		-- when either set or clear button is clicked

		-- step 2: create dac (all from json response when dac creation started)
    DAC_SUBMIT_TIME	TIMESTAMP DEFAULT SYSTIMESTAMP,
    DAC_CREATED_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,	-- resources reserved and DAC creation starting
    DAC_DESTROY_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,	-- resources reserved and DAC creation starting
    DAC_LIFECYCLE_STATE     VARCHAR(255 BYTE),				-- creating, etc
    DAC_CLUSTER_ID     VARCHAR(255 BYTE),		
    DAC_ERROR_DTLS     VARCHAR(4000 BYTE),	
    DAC_UNIT_COUNT     NUMBER,
    DAC_UNIT_SHAPE     VARCHAR(255 BYTE),
    DAC_STARTED_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,	-- dac available for use

 		-- step 3: run finetune   
    FT_SUBMIT_TIME	TIMESTAMP DEFAULT SYSTIMESTAMP,
    FT_CREATED_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,		-- start finetune
    FT_BASE_MODEL_ID     VARCHAR(255 BYTE),
    FT_LIFECYCLE_STATE     VARCHAR(255 BYTE),
    FT_RESULT_MODEL_ID     VARCHAR(255 BYTE),
    FT_TYPE     VARCHAR(255 BYTE),
    FT_VERSION     VARCHAR(255 BYTE),
    FT_COMPLETION_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,	-- end finetune
    FT_ERROR_DTLS     VARCHAR(4000 BYTE),	
 		
    EVAL_START_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP,	
    EVAL_END_TIME     TIMESTAMP DEFAULT SYSTIMESTAMP	

 		
 		-- step 4: deploy
 		-- TBD   

);

CREATE TABLE FINETUNE_EVALUATION (
        ID NUMBER GENERATED ALWAYS AS IDENTITY 
        MINVALUE 1 
        MAXVALUE 9999999999999999999999999999 
        INCREMENT BY 1 
        START WITH 1 
        PRIMARY KEY,
    FINETUNE_WORKFLOW_ID NUMBER NOT NULL,
    EVAL_CATEGORY VARCHAR2(255) NOT NULL,
    PROMPT_TXT VARCHAR2(4000),
    SQL_TRUST_LIBRARY VARCHAR2(4000),
    SQL_LLM_GENERATED VARCHAR2(4000),
    IS_ACCURATE NUMBER NOT NULL,
    LLM_START_TIME TIMESTAMP(6),
    LLM_END_TIME TIMESTAMP(6)
);


CREATE TABLE TRAININGDATA_HISTORY (
    ID	NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    RECORD_COUNT          NUMBER
    FILENAME              VARCHAR2(500)  
    SUBMIT_TIME           TIMESTAMP(6)   
    COMMENTS              VARCHAR2(5000) 
    PATH                  VARCHAR2(2000) 
    )

CREATE TABLE FINETUNE_CONFIG (
    ID	NUMBER GENERATED ALWAYS AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 PRIMARY KEY,
    FINETUNE_WORKFLOW_ID	NUMBER, --FK to FINETUNE_WORKFLOW
    EARLY_STOPPING_PATIENCE	NUMBER,
    EARLY_STOPPING_THRESHOLD	NUMBER,
    LEARNING_RATE	NUMBER,
    LOG_MODEL_METRICS_INTERVAL_IN_STEPS	NUMBER,
    LORA_ALPHA	NUMBER,
    LORA_DROPOUT	NUMBER,
    LORA_R	NUMBER,
    TOTAL_TRAINING_EPOCHS	NUMBER,
    TRAINING_BATCH_SIZE	NUMBER,
    TRAINING_CONFIG_TYPE	VARCHAR(255 BYTE)
);

ALTER TABLE FINETUNE_CONFIG ADD CONSTRAINT FK_FINETUNE_CONFIG_FINETUNE_WORKFLOW FOREIGN KEY(FINETUNE_WORKFLOW_ID) REFERENCES FINETUNE_WORKFLOW(ID);